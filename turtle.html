<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Scroll‑Scrub PNG Frames</title>
  <script src="https://unpkg.com/alpinejs" defer></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
  <style>
    html, body { margin:0; padding:0; font-family:'Poppins',sans-serif; }
    /* wrapper whose height = frames × viewportHeight */
    .scrub-video-wrapper {
      position: relative;
      width: 100%;
      overflow: hidden;
    }
    /* canvas sticks in place */
    .scrub-video-container {
      position: sticky;
      top: 0;
      width: 100%;
      height: 100vh;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    /* fill container */
    #scrubCanvas {
      max-width: 100%;
      max-height: 100%;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div id="header-container"></div>
  <script type="module" src="/scripts/loadHeader.js"></script>

  <!-- scrub wrapper -->
  <div class="scrub-video-wrapper">
    <div class="scrub-video-container">
      <canvas id="scrubCanvas"></canvas>
    </div>
  </div>

  <!-- Footer -->
  <div id="footer-container"></div>
  <script type="module" src="/scripts/loadFooter.js"></script>

  <script>
    class FrameScrubber {
      constructor({ frameCount, framePathPattern }) {
        this.frameCount    = frameCount;
        this.framePath     = framePathPattern;  // e.g. '/public/frames/frame{num}.png'
        this.frames        = new Array(frameCount);
        this.currentReq    = null;
        this.lastDrawn     = -1;

        // DOM refs
        this.wrapper   = document.querySelector('.scrub-video-wrapper');
        this.container = this.wrapper.querySelector('.scrub-video-container');
        this.canvas    = document.getElementById('scrubCanvas');
        this.ctx       = this.canvas.getContext('2d');

        // preload all frames
        this.preloadFrames();
        // initial layout
        window.addEventListener('resize', () => this.onResize());
        document.addEventListener('scroll', () => this.onScroll(), { passive: true });

        // do one resize/draw on init
        this.onResize();
        this.drawFrame(0);
      }

      preloadFrames() {
        for (let i = 0; i < this.frameCount; i++) {
          const img = new Image();
          const num = String(i + 1).padStart(4, '0'); // v4_frames uses 4-digit padding starting from 1
          img.src   = this.framePath.replace('{num}', num);
          this.frames[i] = img;
        }
      }

      onResize() {
        // make wrapper height = frameCount * viewportHeight
        const vh = window.innerHeight;
        this.wrapper.style.height = `${this.frameCount * vh}px`;
        // recompute scroll bounds
        this.top    = this.wrapper.offsetTop;
        this.height = this.wrapper.offsetHeight - vh;
        // fit canvas to container
        const cw = this.container.clientWidth;
        const ch = this.container.clientHeight;
        this.canvas.width  = cw;
        this.canvas.height = ch;
        // redraw current frame
        this.drawFrame(this.lastDrawn >= 0 ? this.lastDrawn : 0);
      }

      onScroll() {
        if (this.currentReq) return;
        this.currentReq = requestAnimationFrame(() => {
          const y = window.scrollY - this.top;
          const prog = Math.max(0, Math.min(1, y / this.height));
          const idx  = Math.floor(prog * (this.frameCount - 1));
          this.drawFrame(idx);
          this.currentReq = null;
        });
      }

      drawFrame(idx) {
        if (idx === this.lastDrawn) return;
        const img = this.frames[idx];
        if (!img.complete) return; // not loaded yet
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        // draw centered: maintain aspect ratio
        const scale = Math.min(
          this.canvas.width  / img.naturalWidth,
          this.canvas.height / img.naturalHeight
        );
        const w = img.naturalWidth * scale;
        const h = img.naturalHeight * scale;
        const x = (this.canvas.width - w) / 2;
        const y = (this.canvas.height - h) / 2;
        this.ctx.drawImage(img, x, y, w, h);
        this.lastDrawn = idx;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      new FrameScrubber({
        frameCount: 150,
        framePathPattern: 'public/v4_frames/turtleExplodev4{num}.png'
      });
    });
  </script>
</body>
</html>
